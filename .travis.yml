language: cpp

addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    - sourceline: 'ppa:beineri/opt-qt571-trusty'
    packages:
    - g++-5
    - qt57-meta-minimal
    - qt57multimedia
    - qt57tools
  homebrew:
    packages:
    - qt5

matrix:
  include:
  - os: linux
    compiler: gcc
    env: [ 'ENV_EVAL="CC=gcc-5 && CXX=g++-5"' ]
  - os: linux
    compiler: clang
  - os: osx
    env: [ 'PATH=/usr/local/opt/qt/bin:$PATH"' ]

before_install:
- eval "${ENV_EVAL}"
- if [ "$TRAVIS_OS_NAME" = "linux" ]; then . /opt/qt57/bin/qt57-env.sh; fi

script:
- mkdir build && cd build
- if [ "$TRAVIS_OS_NAME" != "linux" ]; then cmake .. -DUSE_INTREE_LIBQMC=1; fi # TODO: add building with an external lib
- if [ "$TRAVIS_OS_NAME" = "linux" ]; then  cmake .. -DUSE_INTREE_LIBQMC=1 -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr; fi
- cmake --build . --target all
#- appstream-util validate linux/*.appdata.xml
- |
  if [ "$TRAVIS_OS_NAME" = "linux" ] && [ "$CC" = "clang" ]; then
    make DESTDIR=appdir -j$(nproc) install ; find appdir/
    wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
    chmod a+x linuxdeployqt-continuous-x86_64.AppImage
    unset QTDIR; unset QT_PLUGIN_PATH ; unset LD_LIBRARY_PATH
    export VERSION=$(git rev-parse --short HEAD) # linuxdeployqt uses this for naming the file
    ./linuxdeployqt-continuous-x86_64.AppImage appdir/usr/share/applications/*.desktop -appimage
    wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh
    bash upload.sh Quaternion*.AppImage*
  fi

notifications:
  webhooks:
    urls:
    - "https://scalar.vector.im/api/neb/services/hooks/dHJhdmlzLWNpLyU0MGtpdHN1bmUlM0FtYXRyaXgub3JnLyUyMVBDelV0eHRPalV5U3hTZWxvZiUzQW1hdHJpeC5vcmc"
    on_success: change  # always|never|change
    on_failure: always
    on_start: never
